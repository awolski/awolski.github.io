<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awolski.com/style.css><title>Refactoring with Groovy and runtime method invocation | Tony Wolski</title><meta name=description content="Tony Wolski: You can do some pretty awesome things with Groovy.
I&rsquo;ve been using the language in a number of projects for a couple of years now, and won&rsquo;t even â€¦"><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><meta name=generator content="Hugo 0.74.3"><link rel=canonical href=https://awolski.com/refactoring-with-groovy-and-runtime-method-invocation/></head><body><section id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></section><div id=content><article class=post><header><h1>Refactoring with Groovy and runtime method invocation</h1><small>2015-09-15</small></header><p>You can do some pretty awesome things with Groovy.</p><p>I&rsquo;ve been using the language in a number of projects for a couple of years now, and won&rsquo;t even think about whether to include it in anything new. It&rsquo;s in. No question. (Unless the enterprise forbids it.. rolling). I love the dynamic aspect of it. I love closures. I <em>really</em> love how easy the language makes it when working with Maps and Json (which I do a lot of lately); dot notation for field/attribute access is sooo powerful.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#66d9ef>def</span> map <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>firstName: <span style=color:#e6db74>&#39;Marty&#39;</span><span style=color:#f92672>,</span> surname: <span style=color:#e6db74>&#39;McFly&#39;</span><span style=color:#f92672>]</span>
println map<span style=color:#f92672>.</span><span style=color:#a6e22e>firstName</span>
</code></pre></div><p>Last week I managed to take that power a little bit further by using dynamic/runtime method invocation. Reflection in Java but made <em>groovy</em>.</p><p>I have a class called <code>Jpa</code> which is a little wrapper around and <code>EntityManager</code> and the JPA criteria api. It uses a fluent builder type API so you can chain method calls in order to build up a query. For example</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#a6e22e>@Inject</span> Jpa jpa
<span style=color:#f92672>...</span>
List<span style=color:#f92672>&lt;</span>Entity<span style=color:#f92672>&gt;</span> list <span style=color:#f92672>=</span> jpa<span style=color:#f92672>.</span><span style=color:#a6e22e>queryFor</span><span style=color:#f92672>(</span>Entity<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
                        <span style=color:#f92672>.</span><span style=color:#a6e22e>where</span><span style=color:#f92672>(</span>criteria<span style=color:#f92672>)</span>
                        <span style=color:#f92672>.</span><span style=color:#a6e22e>firstResult</span><span style=color:#f92672>(</span>first<span style=color:#f92672>)</span>
                        <span style=color:#f92672>.</span><span style=color:#a6e22e>maxResults</span><span style=color:#f92672>(</span>pageSize<span style=color:#f92672>)</span>
                        <span style=color:#f92672>.</span><span style=color:#a6e22e>orderBy</span><span style=color:#f92672>(</span>sortField<span style=color:#f92672>)</span>
                        <span style=color:#f92672>.</span><span style=color:#a6e22e>order</span><span style=color:#f92672>(</span>order<span style=color:#f92672>)</span>
                        <span style=color:#f92672>.</span><span style=color:#a6e22e>resultList</span><span style=color:#f92672>()</span>
</code></pre></div><p>In the above example <code>criteria</code> is a list of maps, each map a single criterion. For example, in Json this might look like:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
{
  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;firstName&#34;</span>,
  <span style=color:#f92672>&#34;like&#34;</span>: <span style=color:#e6db74>&#34;Rich&#34;</span>,
  <span style=color:#960050;background-color:#1e0010>...</span>
},
{
  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;surname&#34;</span>,
  <span style=color:#f92672>&#34;like&#34;</span>: <span style=color:#e6db74>&#34;D&#34;</span>,
  <span style=color:#960050;background-color:#1e0010>...</span>
},
  <span style=color:#960050;background-color:#1e0010>...</span>
] 
</code></pre></div><p>What got me looking into dynamic method invocation was needing to make a change to the <code>where(criteria)</code> method. What used to seem reasonably concise to me suddenly made me cringe. Way too much duplication in such a small code block:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>Query<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> where<span style=color:#f92672>(</span>criteria<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
   criteria<span style=color:#f92672>.</span><span style=color:#a6e22e>each</span> <span style=color:#f92672>{</span> criterion <span style=color:#f92672>-&gt;</span>
      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;equals&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
         predicates <span style=color:#f92672>&lt;&lt;</span> cb<span style=color:#f92672>.</span><span style=color:#a6e22e>equal</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>),</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>)</span>
      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;like&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>like</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
         predicates <span style=color:#f92672>&lt;&lt;</span> cb<span style=color:#f92672>.</span><span style=color:#a6e22e>like</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>),</span> <span style=color:#e6db74>&#34;%$criterion.like%&#34;</span><span style=color:#f92672>)</span>
      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;min&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> Strings<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyToNull</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
         predicates <span style=color:#f92672>&lt;&lt;</span> cb<span style=color:#f92672>.</span><span style=color:#a6e22e>greaterThanOrEqualTo</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>),</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>)</span>
      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;max&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> Strings<span style=color:#f92672>.</span><span style=color:#a6e22e>emptyToNull</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span>
         predicates <span style=color:#f92672>&lt;&lt;</span> cb<span style=color:#f92672>.</span><span style=color:#a6e22e>lessThanOrEqualTo</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>),</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>max</span><span style=color:#f92672>)</span>
      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#39;in&#39;</span><span style=color:#f92672>)</span> <span style=color:#f92672>&amp;&amp;</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>in</span><span style=color:#f92672>)</span>
         predicates <span style=color:#f92672>&lt;&lt;</span> cb<span style=color:#f92672>.</span><span style=color:#a6e22e>in</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>),</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>in</span><span style=color:#f92672>)</span>
   <span style=color:#f92672>}</span>
   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Yuck&mldr; you can could do better than that!</p><p>Firstly, there&rsquo;s no need for multiple calls to <code>root.get(criterion.name)</code> in each and every if block, let&rsquo;s pull that out to a single statement at the top of the closure:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>criteria<span style=color:#f92672>.</span><span style=color:#a6e22e>each</span> <span style=color:#f92672>{</span> criterion <span style=color:#f92672>-&gt;</span>
   <span style=color:#f92672>&lt;</span>b<span style=color:#f92672>&gt;</span>Path<span style=color:#f92672>&lt;?&gt;</span> path <span style=color:#f92672>=</span> root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>)&lt;</span><span style=color:#e6db74>/b&gt;
</span><span style=color:#e6db74>   ...
</span><span style=color:#e6db74>   if (criterion.containsKey(&#39;equals&#39;) &amp;&amp; criterion.equals != null)
</span><span style=color:#e6db74>      predicates &lt;&lt; cb.equal(&lt;b&gt;path&lt;/</span>b<span style=color:#f92672>&gt;,</span> criterion<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>)</span>
   <span style=color:#f92672>...</span>
</code></pre></div><p>The next thing I noticed was that the key checks, e.g. <code>criterion.containsKey('equals')</code>, <code>criterion.containsKey('like')</code> were in nearly all cases checking the same method as was being invoked on the criteria builder, e.g. <code>cb.equal</code>, <code>cb.like</code>. I knew Groovy had an <code>eval</code> feature that would allow you to execute plain strings as though they were code, so I did some searching and found <a href=http://mrhaki.blogspot.co.uk/2010/03/groovy-goodness-invoke-methods.html>this post</a> over at <a href=http://www.mrhaki.com/>mrhaki.com</a> (awesome site btw).</p><p>So it looked like I could something along the lines of:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>cb<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;${like}&#34;</span><span style=color:#f92672>(</span>path<span style=color:#f92672>,</span> param<span style=color:#f92672>)</span>
</code></pre></div><p>in place of all those explicit calls. I tested it out briefly with a small snippet of code and BOOM! it worked straight out of the box. I admit I got a little bit excited about the prospect of removing so much unnecessary code. I got to work riding that excitement&mldr;</p><p>I went about changing the operation keys in each criterion to match JPA&rsquo;s <code>CriteriaBuilder</code>'s methods: <code>equals</code> became <code>equal</code>, <code>min</code> became <code>greaterThanOrEqualTo</code> &mldr; you get the idea.</p><p>Next I needed to pull only the <strong>operation</strong> key out of each criterion. For this I needed a list of supported operations</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>def</span> operations <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> 
   <span style=color:#e6db74>&#39;equal&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;like&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;greaterThanOrEqualTo&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;lessThanOrEqualTo&#39;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#39;in&#39;</span> 
<span style=color:#f92672>]</span>
</code></pre></div><p>And pulling those out of each criterion:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>criteria<span style=color:#f92672>?.</span><span style=color:#a6e22e>each</span> <span style=color:#f92672>{</span> c <span style=color:#f92672>-&gt;</span>
   <span style=color:#66d9ef>def</span> ops <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>subMap</span><span style=color:#f92672>(</span>operations<span style=color:#f92672>.</span><span style=color:#a6e22e>keySet</span><span style=color:#f92672>())</span>
</code></pre></div><p>Now it&rsquo;s just a matter of checking that the <code>ops</code> and value for each <code>op</code> are present, and executing the operation on the <code>CriteriaBuilder</code> instance with the given name (path) and value. And now that there is only one call to root.get(c.name) there is no need to extract it to a local variable. Below is the complete method**:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-groovy data-lang=groovy>Query<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> where<span style=color:#f92672>(</span>criteria<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
   criteria<span style=color:#f92672>?.</span><span style=color:#a6e22e>each</span> <span style=color:#f92672>{</span> c <span style=color:#f92672>-&gt;</span>
      <span style=color:#66d9ef>def</span> ops <span style=color:#f92672>=</span> c<span style=color:#f92672>.</span><span style=color:#a6e22e>subMap</span><span style=color:#f92672>(</span>operations<span style=color:#f92672>.</span><span style=color:#a6e22e>keySet</span><span style=color:#f92672>())</span>
      ops<span style=color:#f92672>?.</span><span style=color:#a6e22e>each</span> <span style=color:#f92672>{</span> k<span style=color:#f92672>,</span> v <span style=color:#f92672>-&gt;</span>
         <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>v<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            predicates <span style=color:#f92672>&lt;&lt;</span> cb<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;${k}&#34;</span><span style=color:#f92672>(</span>root<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>c<span style=color:#f92672>.</span><span style=color:#a6e22e>name</span><span style=color:#f92672>),</span> v<span style=color:#f92672>)</span>
         <span style=color:#f92672>}</span>
      <span style=color:#f92672>}</span>
   <span style=color:#f92672>}</span>
   <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Awesome sauce!</p><p>** I&rsquo;ve omitted a few pieces of the final puzzle for brevity and to get the point across a little clearer. For example, what happens if <code>v</code> is actually a <code>Boolean</code> value of false, i.e. you&rsquo;re really searching for a field where the value is <code>false</code>? You&rsquo;d never enter the block where the predicate is created. In my code I&rsquo;ve created a few transform and filter functions for the supported operations, but I&rsquo;ve left those out of the above snippet for clarity.</p><footer>&#171; <a href=https://awolski.com/scratching-the-surface-of-gpg/>Previous</a>
||
<a href=https://awolski.com/building-an-aws-ami-with-packer/>Next</a> &#187;</footer></article><div id=comments><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</div></div></body></html>