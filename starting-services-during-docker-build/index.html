<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=stylesheet type=text/css href=/style.css><title>Starting and using a service during Docker build | Tony Wolski</title><link rel=canonical href=https://awolski.com/starting-services-during-docker-build/></head><body><section id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></section><div id=content><article class=post><header><h1>Starting and using a service during Docker build</h1><small>2015-11-23</small></header><p><strong>Problem</strong>: You&rsquo;re building a image from a Dockerfile and you need to interact with a running process during the build of the said image. How? I really struggled with this question for some time, but I&rsquo;ve since discovered the solution. Read on to find out how&mldr;</p><p>My specific use case is this: start a local npm registry — <a href=https://github.com/rlidwka/sinopia>sinopia</a> — that acts as a proxy with an uplink to another npm registry. Run <code>npm install --registry http://localhost:4873/</code> for a bunch of node modules, which pulls the node modules into the storage directory of the sinopia proxy. Then package up the the proxy sinopia instance as a distributable registry with all dependencies in its <code>storage</code> directory.</p><p>When I first got started with Docker I tried this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#66d9ef>RUN</span> sinopia --config /opt/sinopia/config.yaml<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> npm install --registry http://localhost:4873/ &lt;package&gt;<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>But I soon realised this doesn&rsquo;t work. In this example, by the time the second RUN command executes, sinopia is no longer running. That layer of <a href=https://docs.docker.com/engine/introduction/understanding-docker/#how-does-a-docker-image-work>Union File System</a> has already been committed.</p><p>There are a couple of ways you can achieve this. The first is to chain commands with double ampersand:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#66d9ef>RUN</span> sinopia --config /opt/sinopia/config.yaml <span style=color:#f92672>&amp;&amp;</span> npm install ...<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>The other option, and the one I&rsquo;ve taken in for the aforementioned problem due to the sheer number of things that need to happen while the sinopia registry is up, is to create a build script, <code>ADD</code> it to the Dockerfile and run it like so:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#66d9ef>ADD</span> build.sh /home/sinopia/<span style=color:#960050;background-color:#1e0010>
</span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> /bin/bash -c /home/sinopia/build.sh<span style=color:#960050;background-color:#1e0010>
</span></code></pre></div><p>The <code>build.sh</code> script:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>...
sinopia --config /opt/sinopia/config.yaml
npm install --registry http://localhost:4873/ &lt;package&gt;
...
</code></pre></div><footer>&#171; <a href=https://awolski.com/making-time-blocking-work-with-google-calendar/>Previous</a>
||
<a href=https://awolski.com/fixing-node-gyp-make-failed-on-centos-in-docker/>Next</a> &#187;</footer></article><div id=comments><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</div></div></body></html>