<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awolski.com/style.css><title>Accessing Stormpath Client when using shiro.ini | Tony Wolski</title><meta name=description content="Tony Wolski: I ran into a problem recently while trying to get access to the com.stormpath.sdk.client.Client instance when it is initialised by Apache Shiro&rsquo;s â€¦"><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><link rel=canonical href=https://awolski.com/access-stormpath-client-when-using-shiro-ini/></head><body><header id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article class=post><header><h1>Accessing Stormpath Client when using shiro.ini</h1><small>2014-06-11</small></header><p>I ran into a problem recently while trying to get access to the <code>com.stormpath.sdk.client.Client</code> instance when it is initialised by <a href=http://shiro.apache.org/documentation.html>Apache Shiro</a>&rsquo;s <code>shiro.ini</code> configuration. I couldn&rsquo;t find any help in the <a href=http://shiro.apache.org/webapp-tutorial.html>Shiro</a> or <a href=https://github.com/stormpath/stormpath-shiro/wiki>Stormpath</a> documentation.</p><p>Initially I was creating a separate instance of <code>com.stormpath.sdk.client.Client</code> in code, but I realised I was having to duplicate configuration by specifying <code>apiKeyFileLocation</code> and <code>cacheManager</code> config in both shiro.ini and in environment variables/context parameters.</p><p>In the end it was a simple task of looking into the Shiro and Stormpath source code to find out what is exactly happening&mldr;</p><p>One of the steps of configuring Shiro in a web application is to register a listener in your web.xml:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;listener&gt;</span>
  <span style=color:#f92672>&lt;listener-class&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span style=color:#f92672>&lt;/listener-class&gt;</span>
<span style=color:#f92672>&lt;/listener&gt;</span>
</code></pre></div><p>In its <code>contextInitialized(ServletContextEvent sce)</code> method, it initialises the <code>org.apache.shiro.web.env.WebEnvironment</code> and stores it in a ServletContext for use throughout the application (by Shiro - it exposes the SecurityManager):</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>...</span>
WebEnvironment environment <span style=color:#f92672>=</span> createEnvironment<span style=color:#f92672>(</span>servletContext<span style=color:#f92672>);</span>
servletContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setAttribute</span><span style=color:#f92672>(</span>ENVIRONMENT_ATTRIBUTE_KEY<span style=color:#f92672>,</span> environment<span style=color:#f92672>);</span>
<span style=color:#f92672>...</span>
</code></pre></div><p>Becuase we&rsquo;re using the <code>shiro.ini</code> configuration file, the implementation of WebEnvironment that gets created is the <code>org.apache.shiro.web.env.IniWebEnvironment</code>. Whilst debugging on startup, I noticed that in the in <code>IniWebEnvironment</code>&rsquo;s <code>createWebSecurityManager()</code> method, the beans that are specified in, and loaded from, the <code>shiro.ini</code> file are stored in a <code>this.objects</code> field:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>protected</span> WebSecurityManager <span style=color:#a6e22e>createWebSecurityManager</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
  WebIniSecurityManagerFactory factory<span style=color:#f92672>;</span>
  Ini ini <span style=color:#f92672>=</span> getIni<span style=color:#f92672>();</span>
  <span style=color:#f92672>...</span>
  Map<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> <span style=color:#f92672>?&gt;</span> beans <span style=color:#f92672>=</span> factory<span style=color:#f92672>.</span><span style=color:#a6e22e>getBeans</span><span style=color:#f92672>();</span>
  <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>CollectionUtils<span style=color:#f92672>.</span><span style=color:#a6e22e>isEmpty</span><span style=color:#f92672>(</span>beans<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>objects</span><span style=color:#f92672>.</span><span style=color:#a6e22e>putAll</span><span style=color:#f92672>(</span>beans<span style=color:#f92672>);</span> <span style=color:#75715e>// BOOM!
</span><span style=color:#75715e></span>  <span style=color:#f92672>}</span>
  <span style=color:#66d9ef>return</span> wsm<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Tracing this up the dependency heirarchy we find that <code>this.objects</code> is an instance of <code>Map&lt;String, Object></code> and has a public getter, so accessing the Stormpath Client instance created by Shiro is rather trivial:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StormpathClientProducer</span> <span style=color:#f92672>{</span>

  <span style=color:#a6e22e>@Inject</span>
  ServletContext servletContext<span style=color:#f92672>;</span>

  <span style=color:#a6e22e>@Produces</span> <span style=color:#a6e22e>@Singleton</span>
  <span style=color:#66d9ef>public</span> Client <span style=color:#a6e22e>getStormpathClient</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    DefaultEnvironment env <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>DefaultEnvironment<span style=color:#f92672>)</span> servletContext<span style=color:#f92672>.</span><span style=color:#a6e22e>getAttribute</span><span style=color:#f92672>(</span>ENVIRONMENT_ATTRIBUTE_KEY<span style=color:#f92672>);</span>
    <span style=color:#66d9ef>return</span> env<span style=color:#f92672>.</span><span style=color:#a6e22e>getObject</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;stormpathClient&#34;</span><span style=color:#f92672>,</span> ClientFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>).</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>();</span>
  <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><footer>&#171; <a href=https://awolski.com/first-impression-of-ghost/>Previous</a>
||
<a href=https://awolski.com/deep-work/>Next</a> &#187;</footer><hr><p><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</p></article></main><footer></footer></body></html>