<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><link rel=stylesheet type=text/css href=/style.css><title>Failing aws cli on Docker container with old date time | Tony Wolski</title><link rel=canonical href=https://awolski.com/failing-aws-cli-on-docker-container-with-old-date-time/></head><body><section id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></section><div id=content><article class=post><header><h1>Failing aws cli on Docker container with old date time</h1><small>2016-08-01</small></header><p>Today I hit an issue which completely stumped me (for a while). Running an <code>aws s3 cp</code> from a Docker container — that had <em>never</em> failed before in the same scenario — was failing every time with &lsquo;<code>A client error (403) occurred when calling the HeadObject operation: Forbidden</code>&rsquo;. When run from my Mac directly with the same <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> it worked. <strong>WTF!</strong></p><p>Some Googling lead me to <a href=https://stackoverflow.com/questions/22262906>this</a> question, which contained <a href=http://stackoverflow.com/a/28488143/2309046>this answer</a> of particular interest:</p><blockquote><p>&ldquo;can also be caused if your system clock is too far off. I was 12 hours in the past and got this error. Set the clock to within a minute of the true time, and error went away.&rdquo;</p></blockquote><p>So I checked the time of the container by running <code>date</code> an sure enough, the container&rsquo;s date was 3 days ago:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ date
Fri Jul <span style=color:#ae81ff>29</span> 15:18:17 UTC <span style=color:#ae81ff>2016</span>
</code></pre></div><p>I was a bit perplexed how the container — or Docker — got in such a state, because I&rsquo;d never had an issue like this before. I found <a href=http://stackoverflow.com/a/26454059>this answer</a> which indicated that when using boot2docker the Docker Engine VM&rsquo;s time can drift when OS X is asleep:</p><blockquote><p>&ldquo;Time synch becomes an issue because the boot2docker host has its time drift while your OS is asleep.&rdquo;</p></blockquote><p>I&rsquo;d recently updated to <a href=https://docs.docker.com/docker-for-mac/>Docker for Mac</a>, so maybe that had something to do with it? To correct the issue, I initially tried to set the container&rsquo;s date, before I learned you <a href=http://stackoverflow.com/questions/29556879>can&rsquo;t do that</a> without using <code>--privileged</code>. Doing so can cause bad things to happen:</p><blockquote><p>&ldquo;Using the &ndash;privileged switch here will cause the command from the container to affect the docker host. Also other bad things can happen if you use the &ndash;privileged without knowing the effects.&rdquo;</p></blockquote><p>So I thought the quickest way to see if things would resolve themselves would be to restart my machine (something I don&rsquo;t do often enough). Sure enough, after a restart running the same image produced the correct date and time:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ date
Mon Aug  <span style=color:#ae81ff>1</span> 15:18:17 UTC <span style=color:#ae81ff>2016</span>
</code></pre></div><p>But I wasn&rsquo;t happy with just getting things working again; I wanted to know what the issue was with the aws cli when your system date/time isn&rsquo;t correct. So I dug a little deeper into the <a href=http://docs.aws.amazon.com/cli/latest/userguide/aws-cli.pdf>AWS Command Line Interface User Guide</a> and found the answer on page 10:</p><blockquote><p>The AWS CLI signs requests on your behalf, and includes a date in the signature. Ensure that your computer&rsquo;s date and time are set correctly; if not, the date in the signature may not match the date of the request, and AWS rejects the request.</p></blockquote><p>And there you have it. A mistake not to be made again in the future.</p><footer>&#171; <a href=https://awolski.com/oneplus-2-fingerprint-sensor-not-working-turn-off-gestures/>Previous</a>
||
<a href=https://awolski.com/docker-compose-slow-with-docker-for-mac-and-public-wifi/>Next</a> &#187;</footer></article><div id=comments><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</div></div></body></html>