<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awol.ski/style.css><title>Java Stormpath SDK behind a Proxy using Shiro JndiObjectFactory | Tony Wolski</title><meta name=description content="I needed to develop an application that used the Java Stormpath SDK from behind a corporate proxy. The SDK has a Proxy class just for this purpose, but it â€¦"><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><link rel=canonical href=https://awol.ski/stormpath-java-sdk-behind-a-proxy-using-shiro-jndiobjectfactory/></head><body><header id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article class=post><header><h1>Java Stormpath SDK behind a Proxy using Shiro JndiObjectFactory</h1><small>2015-06-12</small></header><p>I needed to develop an application that used the Java Stormpath SDK from behind a corporate proxy. The SDK has a <a href=https://docs.stormpath.com/java/apidocs/index.html?com/stormpath/sdk/client/Proxy.html>Proxy</a> class just for this purpose, but it doesn&rsquo;t conform to the <a href=http://www.oracle.com/technetwork/java/javase/documentation/spec-136004.html>JavaBeans specification</a> (a good explanation of which can be found <a href=http://stackoverflow.com/a/3295517/2309046>here</a>). The Proxy class has two constructors, both with arguments, and its fields are final. Because I&rsquo;m using Apache Shiro and initialising the Stormpath client using a <a href=https://shiro.apache.org/configuration.html>shiro.ini configuration file</a>, I couldn&rsquo;t see a way to set the Proxy on the ClientBuilder where it was needed.</p><p>I&rsquo;m not sure whether this design is intentional or not. Maybe the Proxy class was created without much thought about Shiro integration. Maybe I&rsquo;m missing something. But I can&rsquo;t find any documentation about how to configure it without doing so in code.</p><p>I still needed a solution though&mldr;</p><p>Then I discovered Shiro&rsquo;s <a href=http://shiro.apache.org/static/1.2.3/apidocs/org/apache/shiro/jndi/JndiObjectFactory.html>JndiObjectFactory</a>, which allows you to look up objects in JNDI from your shiro.ini. Using the approach I&rsquo;ll explain below, I was able to use my system&rsquo;s already configured Java proxy settings - if they are configured - but not have to change any code if I continue develop the application in a non-proxy environment, like at home.</p><p>First, I created an implementation of <code>javax.naming.spi.ObjectFactory</code> that returns a ClientBuilder.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ClientBuilderFactory</span> <span style=color:#66d9ef>implements</span> ObjectFactory <span style=color:#f92672>{</span>

     <span style=color:#a6e22e>@Override</span>
     <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getObjectInstance</span><span style=color:#f92672>(</span>Object obj<span style=color:#f92672>,</span> Name name<span style=color:#f92672>,</span> Context nameCtx<span style=color:#f92672>,</span> Hashtable<span style=color:#f92672>&lt;?,</span> <span style=color:#f92672>?&gt;</span> environment<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>

          ClientBuilder builder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultClientBuilder<span style=color:#f92672>()</span>
     
          String proxyHost <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span>http<span style=color:#f92672>.</span><span style=color:#a6e22e>proxyHost</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>)</span>
          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>proxyHost <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
               <span style=color:#66d9ef>int</span> proxyPort <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span>http<span style=color:#f92672>.</span><span style=color:#a6e22e>proxyPort</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>))</span>
               String proxyUser <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span>http<span style=color:#f92672>.</span><span style=color:#a6e22e>proxyUser</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>)</span>
               String proxyPassword <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#960050;background-color:#1e0010>&#39;</span>http<span style=color:#f92672>.</span><span style=color:#a6e22e>proxyPassword</span><span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>)</span>

               Proxy proxy <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Proxy<span style=color:#f92672>(</span>proxyHost<span style=color:#f92672>,</span> proxyPort<span style=color:#f92672>,</span> proxyUser<span style=color:#f92672>,</span> proxyPassword<span style=color:#f92672>)</span>
               <span style=color:#66d9ef>return</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setProxy</span><span style=color:#f92672>(</span>proxy<span style=color:#f92672>)</span>
          <span style=color:#f92672>}</span>
          <span style=color:#66d9ef>return</span> builder<span style=color:#f92672>;</span>
     <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>The default ClientBuilder used by the stormpath sdk is com.stormpath.sdk.impl.client.DefaultClientBuilder, so we don&rsquo;t reinvent the wheel there. Then we check for the <code>http.proxyHost</code> system property, which you typically set in JAVA_OPTS when you&rsquo;re developing applications that need to talk to the outside world from behind a proxy. If it&rsquo;s present, we create the Proxy object with the <code>http.proxyPort</code>, <code>http.proxyUser</code> and <code>http.proxyPassword</code>. Then set the proxy on the builder.</p><p>The beauty about this is that if there is no proxy argument set for the JVM, the ClientBuilder returned will be exactly the same as that which would have been created during shiro.ini initialisation.</p><p>Next, as per Tomcat&rsquo;s documentation on <a href=https://tomcat.apache.org/tomcat-7.0-doc/jndi-resources-howto.html#Adding_Custom_Resource_Factories>adding custom resource factories</a>, add the factory to your web application&rsquo;s <code>META-INF/context.xml</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;Resource</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;ClientBuilder&#34;</span>
          <span style=color:#a6e22e>auth=</span><span style=color:#e6db74>&#34;Container&#34;</span>
          <span style=color:#a6e22e>type=</span><span style=color:#e6db74>&#34;com.stormpath.sdk.client.ClientBuilder&#34;</span>
          <span style=color:#a6e22e>factory=</span><span style=color:#e6db74>&#34;com.awolski.accounts.stormpath.ClientBuilderFactory&#34;</span>
          <span style=color:#a6e22e>singleton=</span><span style=color:#e6db74>&#34;true&#34;</span> <span style=color:#f92672>/&gt;</span>
</code></pre></div><p>Wire it up in your <code>web.xml</code>:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;resource-env-ref&gt;</span>
    <span style=color:#f92672>&lt;resource-env-ref-name&gt;</span>ClientBuilder<span style=color:#f92672>&lt;/resource-env-ref-name&gt;</span>
    <span style=color:#f92672>&lt;resource-env-ref-type&gt;</span>com.stormpath.sdk.client.ClientBuilder<span style=color:#f92672>&lt;/resource-env-ref-type&gt;</span>
<span style=color:#f92672>&lt;/resource-env-ref&gt;</span>
</code></pre></div><p>And finally, using Shiro&rsquo;s JndiObjectFactory in our shiro.ini, we set the <code>stormpathClient</code>&rsquo;s clientBuilder to the one we created using our factory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>clientBuilder <span style=color:#f92672>=</span> org<span style=color:#f92672>.</span><span style=color:#a6e22e>apache</span><span style=color:#f92672>.</span><span style=color:#a6e22e>shiro</span><span style=color:#f92672>.</span><span style=color:#a6e22e>jndi</span><span style=color:#f92672>.</span><span style=color:#a6e22e>JndiObjectFactory</span>
clientBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>resourceName</span> <span style=color:#f92672>=</span> ClientBuilder
clientBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>resourceRef</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
<span style=color:#f92672>...</span>
stormpathClient <span style=color:#f92672>=</span> com<span style=color:#f92672>.</span><span style=color:#a6e22e>stormpath</span><span style=color:#f92672>.</span><span style=color:#a6e22e>shiro</span><span style=color:#f92672>.</span><span style=color:#a6e22e>client</span><span style=color:#f92672>.</span><span style=color:#a6e22e>ClientFactory</span>
stormpathClient<span style=color:#f92672>.</span><span style=color:#a6e22e>clientBuilder</span> <span style=color:#f92672>=</span> $clientBuilder
</code></pre></div><p>And that&rsquo;s it, you&rsquo;re Stormpath Client will execute its http requests using the proxy configured in your system. No need to add any other proxy settings to your application.</p><footer>&#171; <a href=https://awol.ski/using-docker-to-spin-up-databases-for-development/>Previous</a>
||
<a href=https://awol.ski/enabling-ssh-access-to-vmware-virtual-machine/>Next</a> &#187;</footer><hr><p><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</p></article></main><footer></footer></body></html>