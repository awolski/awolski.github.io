<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awolski.com/style.css><title>Simple and powerful Java metrics with... Metrics | Tony Wolski</title><meta name=description content="You&rsquo;re aware that part of your application is performing poorly and you need to find out exactly what and where, fast. So what do you do? You whack in a â€¦"><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><link rel=canonical href=https://awolski.com/simple-and-poejava-metrics-with-metrics/></head><body><header id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article class=post><header><h1>Simple and powerful Java metrics with... Metrics</h1><small>2015-01-06</small></header><p>You&rsquo;re aware that part of your application is performing poorly and you need to find out exactly what and where, fast. So what do you do? You whack in a few <code>System.currentTimeMillis();</code> calls, subtract the difference and do some conversions, right? WRONG. Give yourself a clip over the ears. And then go and check out <a href=https://dropwizard.github.io/metrics>Metrics</a>.</p><p><img src=/assets/img/2015-01-06-metrics.png alt="Metrics Java Library"></p><blockquote><p><strong>Metrics is a Java library which gives you unparalleled insight into what your code does in production.</strong></p><p><strong>Metrics</strong> provides a powerful toolkit of ways to measure the behavior of critical components <strong>in your production environment</strong>.</p><p>With modules for common libraries like <strong>Jetty</strong>, <strong>Logback</strong>, <strong>Log4j</strong>, <strong>Apache HttpClient</strong>, <strong>Ehcache</strong>, <strong>JDBI</strong>, <strong>Jersey</strong> and reporting backends like <strong>Ganglia</strong> and Graphite, Metrics provides you with full-stack visibility.</p></blockquote><p>Metrics has pretty decent <a href=https://dropwizard.github.io/metrics/3.1.0/getting-started/>getting started documentation</a> with the most common project setups, so there&rsquo;s no point in reproducing that here. But I will elaborate a little on how I used Metrics to gain a <em>lot of insight</em> for very little effort in a project I&rsquo;m currently working on. Bear with me, this will literally take less than a minute&mldr;</p><p>First, you&rsquo;ve got to include the <code>metrics-core</code> library in your application. If you&rsquo;re using Maven, this goes a little something like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;dependencies&gt;</span>
    <span style=color:#f92672>&lt;dependency&gt;</span>
        <span style=color:#f92672>&lt;groupId&gt;</span>io.dropwizard.metrics<span style=color:#f92672>&lt;/groupId&gt;</span>
        <span style=color:#f92672>&lt;artifactId&gt;</span>metrics-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
        <span style=color:#f92672>&lt;version&gt;</span>${metrics.version}<span style=color:#f92672>&lt;/version&gt;</span>
    <span style=color:#f92672>&lt;/dependency&gt;</span>
<span style=color:#f92672>&lt;/dependencies&gt;</span>
</code></pre></div><p>I was using Spring (old style) so I declared a bean for the MetricRegistry.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;bean</span> <span style=color:#a6e22e>class=</span><span style=color:#e6db74>&#34;com.codahale.metrics.MetricRegistry&#34;</span> <span style=color:#f92672>/&gt;</span>
</code></pre></div><p>And inject it into the class where the problem is.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@Autowired</span>
<span style=color:#66d9ef>private</span> MetricRegistry registry<span style=color:#f92672>;</span>
</code></pre></div><p>I&rsquo;m using a <a href=https://dropwizard.github.io/metrics/3.1.0/getting-started/#reporting-via-jmx>JMX Reporter</a> to pull out my metrics, so I set up the reporter in a <code>@PostConstruct</code> intialiser.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@PostConstruct</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initMetrics</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
    reporter <span style=color:#f92672>=</span> JmxReporter<span style=color:#f92672>.</span><span style=color:#a6e22e>forRegistry</span><span style=color:#f92672>(</span>registry<span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>convertRatesTo</span><span style=color:#f92672>(</span>TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>convertDurationsTo</span><span style=color:#f92672>(</span>TimeUnit<span style=color:#f92672>.</span><span style=color:#a6e22e>MILLISECONDS</span><span style=color:#f92672>)</span>
            <span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
    reporter<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Finally, I used a simple timer to record execution time of the method(s) where the problem lies:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Timer<span style=color:#f92672>.</span><span style=color:#a6e22e>Context</span> timer <span style=color:#f92672>=</span> registry<span style=color:#f92672>.</span><span style=color:#a6e22e>timer</span><span style=color:#f92672>(</span>name<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;AccountService&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;getRepayments&#34;</span><span style=color:#f92672>)).</span><span style=color:#a6e22e>time</span><span style=color:#f92672>();</span>
<span style=color:#75715e>// code you&#39;re timing goes here
</span><span style=color:#75715e></span>timer<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
</code></pre></div><p>Simple or what?!</p><p>Once you&rsquo;re application is up and running, and as long as you have remote JMX management enabled on your application server/container, you will be able to see all the information that Metrics produces using a tool like <a href=http://visualvm.java.net/>VisualVM</a> (run jvisualvm from your shell).</p><p><img src=/assets/img/2015-01-06-metrics-jvisualvm.png alt="Metrics with VisualVM"></p><p>There are whole bunch of features that Metrics provides right out of the box like <a href=https://dropwizard.github.io/metrics/3.1.0/getting-started/#gauges>Gauges</a>, <a href=https://dropwizard.github.io/metrics/3.1.0/getting-started/#counters>Counters</a>, <a href=https://dropwizard.github.io/metrics/3.1.0/getting-started/#histograms>Histograms</a>, <a href=https://dropwizard.github.io/metrics/3.1.0/getting-started/#timers>Timers</a>, and <a href=https://dropwizard.github.io/metrics/3.1.0/getting-started/#health-checks>Health Checks</a>, and various reporting mechanisms. Metrics is a great place to start learning about and implementing some metrics gathering in your applications.</p><footer>&#171; <a href=https://awolski.com/never-lose-a-code-snippet-again-with-gistbox/>Previous</a>
||
<a href=https://awolski.com/immutable-um-no-it-isnt/>Next</a> &#187;</footer><hr><p><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</p></article></main><footer></footer></body></html>