<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awol.ski/style.css><title>Monitoring energy use with Google Sheets, Forms and Apps Script | Tony Wolski</title><meta name=description content="I recently set up a nifty little Google Apps Script app using Sheets and Forms to track our electricity and gas consumption, and our solar generation. As Steve â€¦"><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><link rel=canonical href=https://awol.ski/monitoring-energy-use-with-google-sheets-forms-and-apps-script/></head><body><header id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article class=post><header><h1>Monitoring energy use with Google Sheets, Forms and Apps Script</h1><small>2014-01-08</small></header><p>I recently set up a nifty little Google Apps Script app using Sheets and Forms to track our electricity and gas consumption, and our solar generation. As Steve Howard - chief sustainability officer at IKEA - said in his TED talk Let&rsquo;s go all-in on selling sustainability,</p><blockquote><p>&ldquo;If you&rsquo;re not measuring things, you don&rsquo;t care, and you don&rsquo;t know.&rdquo;</p></blockquote><p>I want to know exactly how much energy we are using so that I can make efficiency adjustments over time, and know exactly how each one performs. How are you supposed to know why your bills are so high, or how to reduce them if you need to, when you don&rsquo;t know what you&rsquo;re actually using?</p><p>My requirements for the monitoring tool were:</p><ul><li>Something quick and easy to set up that allowed me to quickly enter meter readings</li><li>A calculation of daily consumption/production based on the day&rsquo;s readings</li><li>If a reading was missed (i.e. we go away on holiday), daily consumption calculation to be averaged out over how many days readings were missed, not spiked on the one day the reading is done</li><li>Calculation of the financial expense and income generated.</li><li>Pretty charts to visualise the data
Google Spreadsheets/Forms covered most of my requirements, and Apps Script gives me the flexibility and power to customise where Spreadsheets falls short.</li></ul><p><strong>Meter Readings Form</strong> - Contains input fields for gas, electricity and solar meter readings. Google Forms now has simple validation to restrict field entries to positive numbers, maximum lengths etc. Nobody else is going to be using my form, but the validation means that when I enter the details on my phone, only the number key pad pops up. Each posted form appends a row to the sheet the form is associated with.</p><p><img src=/assets/img/2014-01-08-meter-readings-form.png alt="Meter readings form"></p><p><strong>Meter Readings Sheet</strong> - This is the sheet that the Form appends to. Each appended row gives me the meter readings for the days I submit the form; but I wanted to know the daily consumption and production, and to not have huge spikes when I forget to, or can&rsquo;t, enter the meter readings. For this, I needed Apps Script.</p><p><img src=/assets/img/2014-01-08-meter-readings.png alt="Meter reading"></p><p><strong>Apps Script</strong> - I created a trigger to run each day between 2am and 3am. The trigger calls an Apps Script function that reads the last row from the meter readings sheet. If the timestamp for the row is within one day, it means I&rsquo;ve entered the readings for that evening. It then reads the penultimate row, calculates the days between the two entries and the average consumption/production values, and for each day between, inserts a new row at the top of the Daily sheet.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>timezone</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>SpreadsheetApp</span>.<span style=color:#a6e22e>getActive</span>().<span style=color:#a6e22e>getSpreadsheetTimeZone</span>();

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>SHEET_METER_READINGS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Meter Readings&#34;</span>;
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>SHEET_DAILY_CONSUMPTION</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Daily&#34;</span>;

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>updateDailyUsage</span>() {
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>meterReadings</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>SpreadsheetApp</span>.<span style=color:#a6e22e>getActive</span>().<span style=color:#a6e22e>getSheetByName</span>(<span style=color:#a6e22e>SHEET_METER_READINGS</span>);

  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>readings</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>meterReadings</span>.<span style=color:#a6e22e>getRange</span>(<span style=color:#a6e22e>meterReadings</span>.<span style=color:#a6e22e>getLastRow</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>meterReadings</span>.<span style=color:#a6e22e>getLastColumn</span>()).<span style=color:#a6e22e>getValues</span>();

  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>penultimateReading</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>readings</span>[<span style=color:#ae81ff>0</span>];
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>lastReading</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>readings</span>[<span style=color:#ae81ff>1</span>];

  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>getDaysBetween</span>(<span style=color:#a6e22e>lastReading</span>[<span style=color:#ae81ff>0</span>], <span style=color:#66d9ef>new</span> Date()) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>daysBetween</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getDaysBetween</span>(<span style=color:#a6e22e>penultimateReading</span>[<span style=color:#ae81ff>0</span>], <span style=color:#a6e22e>lastReading</span>[<span style=color:#ae81ff>0</span>]);
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>consumption</span> <span style=color:#f92672>=</span> [];
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>meterReadings</span>.<span style=color:#a6e22e>getLastColumn</span>(); <span style=color:#f92672>++</span><span style=color:#a6e22e>i</span>) {
      <span style=color:#a6e22e>consumption</span>.<span style=color:#a6e22e>push</span>(((<span style=color:#a6e22e>lastReading</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>-</span> <span style=color:#a6e22e>penultimateReading</span>[<span style=color:#a6e22e>i</span>]) <span style=color:#f92672>/</span> <span style=color:#a6e22e>daysBetween</span>).<span style=color:#a6e22e>toFixed</span>(<span style=color:#ae81ff>1</span>));
    }
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> [];
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>date</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>lastReading</span>[<span style=color:#ae81ff>0</span>];
    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>daysBetween</span>; <span style=color:#f92672>++</span><span style=color:#a6e22e>i</span>) {
      <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>push</span>([<span style=color:#a6e22e>Utilities</span>.<span style=color:#a6e22e>formatDate</span>(<span style=color:#a6e22e>date</span>, <span style=color:#a6e22e>timezone</span>, <span style=color:#e6db74>&#34;dd/MM/yyyy&#34;</span>)].<span style=color:#a6e22e>concat</span>(<span style=color:#a6e22e>consumption</span>));
      <span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>setDate</span>(<span style=color:#a6e22e>date</span>.<span style=color:#a6e22e>getDate</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
    }

    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>dailyConsumption</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>SpreadsheetApp</span>.<span style=color:#a6e22e>getActive</span>().<span style=color:#a6e22e>getSheetByName</span>(<span style=color:#a6e22e>SHEET_DAILY_CONSUMPTION</span>);
    <span style=color:#a6e22e>dailyConsumption</span>.<span style=color:#a6e22e>insertRowsBefore</span>(<span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>daysBetween</span>);
    <span style=color:#a6e22e>dailyConsumption</span>.<span style=color:#a6e22e>getRange</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>daysBetween</span>, <span style=color:#a6e22e>meterReadings</span>.<span style=color:#a6e22e>getLastColumn</span>()).<span style=color:#a6e22e>setValues</span>(<span style=color:#a6e22e>data</span>);
  }
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getDaysBetween</span>(<span style=color:#a6e22e>first</span>,<span style=color:#a6e22e>second</span>) {
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>oneDay</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24</span><span style=color:#f92672>*</span><span style=color:#ae81ff>60</span><span style=color:#f92672>*</span><span style=color:#ae81ff>60</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000</span>;
  <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>round</span>(Math.<span style=color:#a6e22e>abs</span>((<span style=color:#a6e22e>first</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>second</span>.<span style=color:#a6e22e>getTime</span>())<span style=color:#f92672>/</span>(<span style=color:#a6e22e>oneDay</span>)));
}
</code></pre></div><p><strong>Daily Sheet</strong> - The daily sheet is written to by the Apps Script function, each row being inserted at the top of the sheet, because I don&rsquo;t want to have to scroll miles to the bottom when the sheet is years old. As well as columns for gas, electricity and solar production/consumption, I have columns for gas and electricity cost, and solar income, which are calculated using the day&rsquo;s readings (on the same row) and the&mldr;</p><p><img src=/assets/img/2014-01-08-daily.png alt="Daily sheet"></p><p><strong>Tariffs Sheet</strong> - I&rsquo;ve input my gas and electricity daily standing charge and tariffs, as well as my solar Feed in Tariff in a single row. The Daily Sheet&rsquo;s cost and income values are calculated using these. When my tariffs change, I&rsquo;ll simply insert a row with the new tariffs, and future calculations will be made from those, whilst older ones will remain calculated against the previous ones.</p><p><img src=/assets/img/2014-01-08-tariffs.png alt="Tariffs sheet"></p><p><strong>Pretty Graphs Sheet</strong> - Well, speaks for itself really:</p><p><img src=/assets/img/2014-01-08-pretty-graphs.png alt="Pretty graphs"></p><footer>&#171; <a href=https://awol.ski/javaone-2013-decompose-that-war-architecting-for-adaptability-scalability-and-deployability/>Previous</a>
||
<a href=https://awol.ski/keeping-a-primefaces-menuitem-active/>Next</a> &#187;</footer><hr><p><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</p></article></main><footer></footer></body></html>