<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awolski.com/style.css><title>Problems building a CentOS AWS AMI with Packer | Tony Wolski</title><meta name=description content="Tony Wolski: I&rsquo;m in the early stages of working with (awesome) tools like Packer and Terraform and I ran into a few issues whilst trying to create a base image that â€¦"><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><meta name=generator content="Hugo 0.69.0"><link rel=canonical href=https://awolski.com/building-an-aws-ami-with-packer/></head><body><section id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></section><div id=content><article class=post><header><h1>Problems building a CentOS AWS AMI with Packer</h1><small>2015-09-16</small></header><p>I&rsquo;m in the early stages of working with (awesome) tools like Packer and <a href=https://www.terraform.io/>Terraform</a> and I ran into a few issues whilst trying to create a base image that mirrors the production environment we&rsquo;re deploying to. I wanted to document them here to a) engrain what I&rsquo;m learning and b) document the solutions for future reference.</p><p>When getting started with any new technology it&rsquo;s good to work your way through the getting started guide, which is what I did on this occasion. I copied the <code>example.json</code> example from Packer&rsquo;s <a href=https://www.packer.io/intro/getting-started/build-image.html>getting started guide</a> and changed the instance type from <code>t1.micro</code> to <code>t2.micro</code> and the ami to an <code>eu-west-1</code> CentOS 6 ami. So here is what I started with:</p><script type=application/javascript src=https://gist.github.com/awolski/8fd8798070fa69f42ff6711432bc294d.js></script><p>Running</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>packer validate example.json
</code></pre></div><p>worked without error, so I continued with</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>packer build example.json
</code></pre></div><p>And I hit an error&mldr;</p><h2 id=problem-not-specifying-subnet_id-when-using-non-default-vpc>Problem: Not specifying subnet_id when using non-default VPC</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#f92672>==</span>&gt; amazon-ebs: Error launching source instance: InvalidParameterCombination: VPC security groups may not be used <span style=color:#66d9ef>for</span> a non-VPC launch
</code></pre></div><p>The error on this one through me a little bit as it points to something awry with security groups. But the real issue solution is to do with the switching to a t2.micro instance and not specifying a <code>vpc_ic</code> and <code>subnet_id</code>. From the <a href=http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/t2-instances.html>T2 Instances documentation</a>:</p><blockquote><p>You must launch your T2 instances into a virtual private cloud (VPC); they are not supported on the EC2-Classic platform.</p></blockquote><p>So I added a <code>vpc_id</code> and <code>subnet_id</code> to the template:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>  <span style=color:#960050;background-color:#1e0010>...</span>
  <span style=color:#e6db74>&#34;vpc_id&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;vpc-62086907&#34;</span><span style=color:#960050;background-color:#1e0010>,</span>
  <span style=color:#e6db74>&#34;subnet_id&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#e6db74>&#34;subnet-01451564&#34;</span><span style=color:#960050;background-color:#1e0010>,</span>
  <span style=color:#960050;background-color:#1e0010>...</span>
</code></pre></div><p>Running <code>packer build</code> now didn&rsquo;t hit this issue, but seemed to take an eternity when trying to connect via SSH&mldr;</p><h2 id=problem-timeout-waiting-for-ssh>Problem: Timeout waiting for SSH.</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>amazon-ebs output will be in this color.
amazon-ebs: Prevalidating AMI Name...
amazon-ebs: Inspecting the source AMI...
...
amazon-ebs: Waiting <span style=color:#66d9ef>for</span> instance <span style=color:#f92672>(</span>i-cfbf6363<span style=color:#f92672>)</span> to become ready...
amazon-ebs: Waiting <span style=color:#66d9ef>for</span> SSH to become available...
amazon-ebs: Timeout waiting <span style=color:#66d9ef>for</span> SSH.
...
amazon-ebs: Terminating the source AWS instance...
</code></pre></div><p>This is when I discovered that when launching an ec2 instance into a non-default subnet the instance is not assigned a public IP. This is explained in AWS&rsquo; <a href=http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/default-vpc.html>Default VPC and Subnet documentation</a>:</p><blockquote><p>Instances that you launch into a default subnet receive both a public IP address and a private IP address. Instances in a default subnet also receive both public and private DNS hostnames. Instances that you launch into a nondefault subnet in a default VPC don&rsquo;t receive a public IP address or a DNS hostname. You can change your subnet&rsquo;s default public IP addressing behavior. For more information, see Modifying Your Subnet&rsquo;s Public IP Addressing Behavior.</p></blockquote><p>So I dug a little deeper into Packer&rsquo;s <a href=https://www.packer.io/docs/builders/amazon-ebs.html>aws-ebs backed documentation</a> and discovered the way to fix this is to add the <code>associate_public_ip_address</code> (<code>true</code>) attribute:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>  <span style=color:#e6db74>&#34;associate_public_ip_address&#34;</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>true</span>
</code></pre></div><p>So the final (working) packer template is listed below (changes I&rsquo;ve made from the example in the documentation are highlighted):</p><script type=application/javascript src=https://gist.github.com/awolski/8fd8798070fa69f42ff6711432bc294d.js></script><footer>&#171; <a href=https://awolski.com/refactoring-with-groovy-and-runtime-method-invocation/>Previous</a>
||
<a href=https://awolski.com/sudden-permission-denied-publickey-error-in-travis/>Next</a> &#187;</footer></article><div id=comments><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</div></div></body></html>