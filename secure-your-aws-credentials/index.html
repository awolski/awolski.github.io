<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awolski.com/style.css><title>Secure your AWS Credentials | Tony Wolski</title><meta name=description content="Tony Wolski: Stop leaving your AWS CLI credentials lying around in plain text. Encrypt them with GPG and use credential_process and a security device like Yubikey to keep them safe."><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><meta name=generator content="Hugo 0.80.0"><link rel=canonical href=https://awolski.com/secure-your-aws-credentials/></head><body><section id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></section><div id=content><article class=post><header><h1>Secure your AWS Credentials</h1><small>2021-02-01</small></header><p>You shouldn&rsquo;t keep credentials in plain-text, right? (Hint: the answer is <em>no, you shouldn&rsquo;t</em>). So why is keeping AWS command line credentials in <code>~/.aws/credentials</code> so common? Probably because setting up anything more secure adds a disproportionate level of complexity, when what you really want is get on with the fun stuff, developing.</p><p>I wanted to something a little more secure than plain text <code>aws_access_key_id</code> and <code>aws_secret_access_key</code> in <code>~/.aws/credentials</code>. What I came up with, I think, provides a good level of security without too much overhead. My solution uses <a href=https://www.passwordstore.org/>pass</a> to store credentials encrypted, physical access to a Yubikey to decrypt them, a tiny custom bash script, and the <code>aws cli</code> <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sourcing-external.html>external process</a> utility.</p><p>First up, I use <a href=https://www.passwordstore.org/><code>pass</code></a> to store my passwords and secrets (and other stuff). It&rsquo;s great. Simple and secure, storing each secret in a <code>gpg</code> encrypted file. For my AWS credentials solution my <code>personal/aws</code> entry looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ pass personal/aws

&lt;web-console-password&gt;
url: https://&lt;aws-account-number&gt;.signin.aws.amazon.com/console
user: &lt;username&gt;
access_key_id: &lt;access-key-id&gt; 
secret_access_key: &lt;secret-access-key&gt;
</code></pre></div><p>The great thing about this is all of my AWS details are in one place.</p><p>I keep my GPG subkeys, including the encryption key, on a Yubikey. So to decrypt anything in the password store you need a) physical access to the Yubikey, and b) the passphrase to unlock it. Three wrong guesses and it&rsquo;s locked.</p><p>Next, I wrote a script to call <code>pass</code> and extract the <code>access_key_id</code> and <code>secret_access_key</code> values into a format that aws cli&rsquo;s <code>credential_process</code> requires (visit AWS docs for more details on <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sourcing-external.html>sourcing credentials with an external process</a>).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/usr/bin/env bash
</span><span style=color:#75715e></span>
access_key_id<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pass <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> | grep access_key_id | sed -r <span style=color:#e6db74>&#39;s/^(.*: )(.*)/\2/g&#39;</span><span style=color:#66d9ef>)</span>
secret_access_key<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>pass <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> | grep secret_access_key | sed -r <span style=color:#e6db74>&#39;s/^(.*: )(.*)/\2/g&#39;</span><span style=color:#66d9ef>)</span>

echo <span style=color:#e6db74>&#39;{ &#34;Version&#34;: 1, &#34;AccessKeyId&#34;: &#34;&#39;</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>access_key_id<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>&#39;&#34;, &#34;SecretAccessKey&#34;: &#34;&#39;</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>secret_access_key<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>&#39;&#34; }&#39;</span>
</code></pre></div><p>The script takes the password store credential name as an argument (ensure it is executable and on the <code>PATH</code>).</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ aws_login personal/aws
</code></pre></div><p>The card reader kicks in and asks to unlock the Yubikey:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>               ┌──────────────────────────────────────────────┐            
               │ Please unlock the card                       │            
               │                                              │            
               │ Number: <span style=color:#ae81ff>0002</span> <span style=color:#ae81ff>19533393</span>                        │            
               │ Holder: Your Name                            │            
               │                                              │            
               │ PIN ________________________________________ │            
               │                                              │            
               │      &lt;OK&gt;                        &lt;Cancel&gt;    │            
               └──────────────────────────────────────────────┘
</code></pre></div><p>Output looks like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{ <span style=color:#f92672>&#34;Version&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&#34;AccessKeyId&#34;</span>: <span style=color:#e6db74>&#34;&lt;access-key-id&gt;&#34;</span>, <span style=color:#f92672>&#34;SecretAccessKey&#34;</span>: <span style=color:#e6db74>&#34;&lt;secret-access-key&gt;&#34;</span> }
</code></pre></div><p>Finally, I removed my <code>~.aws/credentials</code> file and added the <code>credential_process</code> line to your <code>~/.aws/config</code> file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#f92672>[</span>default<span style=color:#f92672>]</span>
region <span style=color:#f92672>=</span> eu-west-2
output <span style=color:#f92672>=</span> json
credential_process <span style=color:#f92672>=</span> aws_login personal/aws
</code></pre></div><p>That&rsquo;s it, no more plain text credentials lying around! Now when I execute an <code>aws</code> command the cli runs my script to extract the encrypted credentials, prompting me for Yubikey passphrase if I haven&rsquo;t already entered it in the session.</p><footer>&#171; <a href=https://awolski.com/quarantine/>Previous</a></footer></article><div id=comments><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</div></div></body></html>