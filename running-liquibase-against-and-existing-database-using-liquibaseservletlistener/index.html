<!doctype html><html lang=en-gb><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://awolski.com/style.css><title>Running Liquibase against and existing database using LiquibaseServletListener | Tony Wolski</title><meta name=description content="Tony Wolski: I recently took on the task of integrating Liquibase into the project I&rsquo;m working on at work. I&rsquo;d played around with Liquibase before on small â€¦"><meta name=author content="Tony Wolski"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=referrer content="no-referrer"><link rel=canonical href=https://awolski.com/running-liquibase-against-and-existing-database-using-liquibaseservletlistener/></head><body><header id=masthead><h1><a href=/ title="Tony Wolski">Tony Wolski</a></h1><nav><ul><li><a href=/contact title=Contact>Contact</a></li></ul></nav></header><main><article class=post><header><h1>Running Liquibase against and existing database using LiquibaseServletListener</h1><small>2013-10-14</small></header><p>I recently took on the task of integrating <a href=http://www.liquibase.org/>Liquibase</a> into the project I&rsquo;m working on at work. I&rsquo;d played around with Liquibase before on small personal projects, but had never faced applying it to an existing, large and in-production database.</p><p>I ran into a few problems when using the LiquibaseServletListener after having previously run changelogSync via the command line. Basically, Liquibase was trying to execute the changesets in my changelog files even though they had already been executed during changelogSync. I couldn&rsquo;t understand why.</p><p>I had executed Liquibase&rsquo;s changelogSync from the command line in the same directory as the file generated by generateChangeLog, something along these lines:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>liquibase --driver<span style=color:#f92672>=</span>com.mysql.jdbc.Driver <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --classpath<span style=color:#f92672>=</span>mysql-connector-java-5.1.13-bin.jar <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --changeLogFile<span style=color:#f92672>=</span>accounts-changelog-schema.xml <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --url<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;jdbc:mysql://localhost:3306/accounts&#34;</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --username<span style=color:#f92672>=</span>user --password<span style=color:#f92672>=</span>password changelogSync
</code></pre></div><p>Afterwards, the rows in Liquibase&rsquo;s DATABASECHANGELOG table indicated everything had worked, and each of the changesets had an EXECTYPE of EXECUTED, which should have meant when the servlet listener started up the changesets would be skipped over. But Liquibase was trying to execute the changesets and I was getting a log full of errors.</p><p>Turns out that because I had defined my changelog file in a subdirectory:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;context-param&gt;</span>
  <span style=color:#f92672>&lt;param-name&gt;</span>liquibase.changelog<span style=color:#f92672>&lt;/param-name&gt;</span>
  <span style=color:#f92672>&lt;param-value&gt;</span>db/changelog/accounts-changelog-schema.xml<span style=color:#f92672>&lt;/param-value&gt;</span>
<span style=color:#f92672>&lt;/context-param&gt;</span>
</code></pre></div><p>And had run changelogSync from the same directory as the generated changelog (which meant the FILENAME field for each changeset was &lsquo;accounts-changelog-schema.xml&rsquo;), the FILENAME field didn&rsquo;t match. Hence Liquibase&rsquo;s attempts to re-run the changesets.</p><p>Fixing the problem was simply a matter of updating the database</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>update</span> DATABASASECHANGELOG <span style=color:#66d9ef>set</span> FILENAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;db/changelog/accounts-changelog-schema.xml&#39;</span>;
</code></pre></div><footer>&#171; <a href=https://awolski.com/staying-focused-on-performance-with-evernote-and-ifttt/>Previous</a>
||
<a href=https://awolski.com/javaone-2013-decompose-that-war-architecting-for-adaptability-scalability-and-deployability/>Next</a> &#187;</footer><hr><p><strong>Your thoughts?</strong> I'd love to hear them. Please get in <a href=/contact>contact</a>.</p></article></main><footer></footer></body></html>